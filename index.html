<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - QRIS Static iPaymu</title>
     <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; 
        }
        .container { 
            max-width: 500px; margin: 0 auto; background: white; 
            border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        h1 { color: #333; margin-bottom: 10px; }
        .subtitle { color: #666; margin-bottom: 20px; }
        .store-info {
            background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left;
        }
        .qr-container { 
            margin: 20px 0; padding: 20px; border: 2px dashed #ddd; border-radius: 10px; background: white;
        }
        .instructions {
            background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;
        }
        .status-container { 
            margin: 20px 0; padding: 15px; border-radius: 8px; text-align: center; display: none;
        }
        .status-pending { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status-success { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .status-failed { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .payment-details {
            background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left; display: none;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
            padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 5px; font-size: 14px;
        }
        .success { background: #28a745; }
        .failed { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè™ POS STORE</h1>
        <p class="subtitle">QRIS Static - iPaymu</p>
        
        <div class="store-info">
            <h3>üìã Informasi Toko</h3>
            <p><strong>Metode:</strong> QRIS Static</p>
            <p><strong>Status:</strong> <span id="storeStatus">üü¢ Online</span></p>
        </div>
        
        <div class="instructions">
            <h3>üì± Cara Bayar:</h3>
            <ol>
                <li>Scan QR code dengan e-wallet</li>
                <li>Input amount yang ingin dibayar</li>
                <li>Konfirmasi pembayaran</li>
                <li>Tunggu notifikasi suara</li>
            </ol>
        </div>
        
        <div class="qr-container">
            <canvas id="qrcode"></canvas>
            <p><small>Terakhir update: <span id="lastUpdated"></span></small></p>
        </div>

        <div class="payment-details" id="paymentDetails">
            <h4>üìÑ Transaksi Terakhir</h4>
            <p><strong>Status:</strong> <span id="detailStatus">-</span></p>
            <p><strong>Amount:</strong> <span id="detailAmount">-</span></p>
            <p><strong>Waktu:</strong> <span id="detailTime">-</span></p>
        </div>
        
        <div id="statusContainer" class="status-container">
            <h3 id="statusTitle">Status Pembayaran</h3>
            <p id="statusMessage">Scan QR code untuk memulai</p>
        </div>

        <div>
            <button onclick="testSuccess()" class="success">Test Suara Sukses</button>
            <button onclick="testFailed()" class="failed">Test Suara Gagal</button>
            <button onclick="reloadQR()">üîÑ Reload QR</button>
        </div>
    </div>

    <audio id="successSound" preload="auto"></audio>
    <audio id="failedSound" preload="auto"></audio>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        let soundEnabled = true;
        let checkInterval = null;

        // Initialize
        window.addEventListener('load', function() {
            loadStaticQR();
            startPaymentChecking();
            showStatus('pending', 'Scan QR code untuk pembayaran');
        });

        // QR Code
        async function loadStaticQR() {
            try {
                const response = await fetch('/.netlify/functions/get-static-qr');
                const qrString = await response.text();
                
                await QRCode.toCanvas(document.getElementById('qrcode'), qrString, {
                    width: 250, margin: 2
                });
                
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error loading QR:', error);
                showStatus('failed', 'Gagal memuat QR code');
            }
        }

        function reloadQR() {
            loadStaticQR();
            showStatus('pending', 'QR code diperbarui');
        }

        // Payment Checking - Polling ke callback function
        function startPaymentChecking() {
            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch('/.netlify/functions/ipaymu-callback');
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // Cek jika ada payment baru dengan status berhasil/gagal
                        const payments = Object.values(data.data);
                        const latestPayment = payments.find(p => 
                            p.status === 'berhasil' || p.status === 'gagal'
                        );
                        
                        if (latestPayment) {
                            handlePaymentUpdate(latestPayment);
                        }
                    }
                } catch (error) {
                    console.error('Error checking payment:', error);
                }
            }, 3000);
        }

        function handlePaymentUpdate(payment) {
            if (payment.status === 'berhasil') {
                playSuccessSound(payment.amount);
                showPaymentDetails(payment);
            } else if (payment.status === 'gagal') {
                playFailedSound();
                showPaymentDetails(payment);
            }
        }

        // Sound Functions
        function playSuccessSound(amount) {
            const audio = document.getElementById('successSound');
            audio.play().catch(e => console.log('Audio error:', e));
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(
                    `Pembayaran ${formatAmount(amount)} rupiah berhasil`
                );
                utterance.lang = 'id-ID';
                speechSynthesis.speak(utterance);
            }
            
            showStatus('success', `‚úÖ Pembayaran Rp ${formatAmount(amount)} berhasil!`);
        }

        function playFailedSound() {
            const audio = document.getElementById('failedSound');
            audio.play().catch(e => console.log('Audio error:', e));
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('Pembayaran gagal');
                utterance.lang = 'id-ID';
                speechSynthesis.speak(utterance);
            }
            
            showStatus('failed', '‚ùå Pembayaran gagal');
        }

        // UI Functions
        function showStatus(status, message) {
            const container = document.getElementById('statusContainer');
            container.className = 'status-container';
            container.style.display = 'block';
            
            if (status === 'pending') container.classList.add('status-pending');
            if (status === 'success') container.classList.add('status-success');
            if (status === 'failed') container.classList.add('status-failed');
            
            document.getElementById('statusTitle').textContent = 
                status === 'pending' ? '‚è≥ Menunggu' : 
                status === 'success' ? '‚úÖ Berhasil' : '‚ùå Gagal';
            document.getElementById('statusMessage').textContent = message;
        }

        function showPaymentDetails(payment) {
            document.getElementById('detailStatus').textContent = 
                payment.status === 'berhasil' ? '‚úÖ Berhasil' : '‚ùå Gagal';
            document.getElementById('detailAmount').textContent = 
                payment.amount ? `Rp ${formatAmount(payment.amount)}` : '-';
            document.getElementById('detailTime').textContent = 
                new Date(payment.updated_at).toLocaleTimeString();
            
            document.getElementById('paymentDetails').style.display = 'block';
        }

        function formatAmount(amount) {
            return amount ? amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") : '0';
        }

        // Test Functions
        function testSuccess() {
            const amount = Math.floor(Math.random() * 50000) + 1000;
            playSuccessSound(amount);
            showPaymentDetails({
                status: 'berhasil',
                amount: amount,
                updated_at: new Date().toISOString()
            });
        }

        function testFailed() {
            playFailedSound();
            showPaymentDetails({
                status: 'gagal',
                amount: null,
                updated_at: new Date().toISOString()
            });
        }

        // Preload sound on first click
        document.addEventListener('click', function initSound() {
            document.removeEventListener('click', initSound);
            const audio = document.getElementById('successSound');
            audio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3';
            const audio2 = document.getElementById('failedSound');
            audio2.src = 'https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3';
        }, { once: true });
    </script>
</body>
</html>
